<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
		
		<title>
			投诉
		</title>
		<link rel="stylesheet" href="css/weui.min.css">
		<style>
		    [v-cloak]{
		        display:none;
		    }
		</style>
		<script>
    	    if(!(location.search.indexOf('version') > -1)) { //防止缓存出以前的二维码
    	        location.href = location.href + '?version='+ new Date().getTime()
    	    }
	    </script>
	</head>
	
	<body data-weui-theme="light">
		<div id="app" v-cloak>
		    <div v-if="!submitSuccess">
    			<div style="background-color: #eee;">
    				<div class="weui-cells__title" style="background-color: #eee; margin-top: 0; padding-top: 16px; padding-bottom: 8px;">
    					<span style="color: red;">* </span>请选择投诉该账号的原因：
    				</div>
    				<div class="weui-cells" style="padding-left: 32px">
    					<a href="javascript:" class="weui-cell weui-cell_access" v-for="(item,index) in allList"  @click="change(item)">
    						<div class="weui-cell__bd">
    							<p>
    								<input class="weui-cells_radio" type="radio" name="abc" :id="item.tid" :value="index"  style="margin-left: -32px; width:20px; height:20px; vertical-align: middle;"/><label :for="item.tid" style="margin-left: 8px;">{{item.text}}</label>
    							</p>
    						</div>
    						<!--<div class="weui-cell__ft">-->
    						<!--</div>-->
    					</a>
    				</div>
    			</div>
    			
    			<div class="weui-cells__group weui-cells__group_form" >
        			<div class="weui-cells__title" style="background-color: #eee; margin-top: 0; padding-top: 16px; padding-bottom: 8px;">
        				<span style="color: red;">* </span>投诉原因描述
        			</div>
        			<div class=" weui-cells_form">
        				<div class="weui-cell">
        					<div class="weui-cell__bd">
        						<textarea placeholder="请输入投诉说明" maxlength="200" rows="4" class="weui-textarea" v-model="content"></textarea>
        						<div class="weui_textarea_counter" style="text-align: right; font-size: 14px; color: #999;"><span id="count">{{content.length}}</span>/200</div>
        					</div>
        				</div>
        			</div>
        		</div>
        		
    			<div class="weui-form" style="padding:0px">
                	<div class="" style="">
                		<div class="weui-cells__group weui-cells__group_form">
                			<div class="weui-cells__title" style="background-color: #eee; margin-top: 0; padding-top: 16px; padding-bottom: 8px;">
        				        <span style="color: red;">* </span>联系客服立即处理
        			        </div>
                		</div>
                		<div class="" style="display: flex; display: -webkit-flex; justify-content: center; margin-bottom: 30px;">
                			<img src="./zcz.jpg" alt="" style="width: 90%"/>
                		</div>
                		
                	</div>
                	<div class="weui-form__opr-area">
                		<a href="javascript:" class="weui-btn weui-btn_primary" @click="submit">
                			提交
                		</a>
                	</div>
                </div>
            </div>
            <div class="page" v-else>
                <div class="weui-msg">
                    <div class="weui-msg__icon-area"><i class="weui-icon-success weui-icon_msg"></i></div>
                    <div class="weui-msg__text-area">
                        <h2 class="weui-msg__title">投诉已提交</h2>
                        <p class="weui-msg__desc">您的投诉内容已提交处理，我们会尽快核实，并通知您审核结果。感谢您的支持</p>
                    </div>
                    <div class="weui-msg__opr-area">
                        <p class="weui-btn-area">
                            <a href="javascript:alert('确认要关闭当前页面吗?');window.location.href='about:blank';window.close();wx.closeWindow()" class="weui-btn weui-btn_primary">关闭</a>
                        </p>
                    </div>
                    <div class="weui-msg__tips-area"></div>
                    <div class="weui-msg__extra-area">
                        <div class="weui-footer"></div>
                    </div>
                </div>
            </div>
		</div>
		<!--<script src="Scripts/vue@2.6.js"></script>-->
		<!--<script src="Scripts/jquery.min.js"></script>-->
        <!--<script src="Scripts/jquery.min.js"></script>-->
        <!--<script src="Scripts/vue.js"></script>-->
        <script src="js/scripts/vue-2.6.12.js"></script>
        <script src="js/scripts/jquery.min.js"></script>
        <script src="js/scripts/jweixin-1.6.0.js"></script>
		<script>
		    (function(){
                window.alert = function(name){
                    var iframe = document.createElement("IFRAME");
                    iframe.style.display="none";
                    iframe.setAttribute("src", 'data:text/plain');
                    document.documentElement.appendChild(iframe);
                    window.frames[0].window.alert(name);
                    iframe.parentNode.removeChild(iframe);
                }
            })();
			function getUrlQuery(name) {
				let reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
				let r = window.location.search.substr(1).match(reg);
				if (r != null) {
					return decodeURIComponent(r[2]);
				}
				return null;
			}
			function getBody(xhr) {
				const text = xhr.responseText || xhr.response;
				if (!text) {
					return text;
				}

				try {
					return JSON.parse(text);
				} catch(e) {
					return text;
				}
			}
			function upload(option) {
				if (typeof XMLHttpRequest === "undefined") {
					return;
				}
				const xhr = new XMLHttpRequest();
				const action = option.action;
				if (xhr.upload) {
					xhr.upload.onprogress = function progress(e) {
						if (e.total > 0) {
							e.percent = (e.loaded / e.total) * 100;
						}
						option.onProgress(e);
					};
				}
				const formData = new FormData();
				if (option.data) {
					Object.keys(option.data).map((key) => {
						formData.append(key, option.data[key]);
					});
				}
				if (option.filename) {
					formData.append(option.filename, option.file);
				}
				xhr.onerror = function error(e) {
					option.onError(e);
				};
				xhr.onload = function onload() {
					if (xhr.status < 200 || xhr.status >= 300) {
						return option.onError(getError(action, option, xhr), getBody(xhr));
					}

					option.onSuccess(getBody(xhr));
				};
				xhr.open("post", action, true);
				if (option.withCredentials && "withCredentials" in xhr) {
					xhr.withCredentials = true;
				}
				const headers = option.headers || {};
				for (let item in headers) {
					if (headers.hasOwnProperty(item) && headers[item] !== null) {
						xhr.setRequestHeader(item, headers[item]);
					}
				}
				xhr.send(formData);
			};
			wx.config({
			    debug: false,
			    appId: "",
			    timestamp: "",
			    nonceStr: "",
			    signature: "",
			    jsApiList: []
			})
			wx.ready(function(){
			    
			});
			wx.error(function(res){
			    
			});
		</script>
		<script>
			var app = new Vue({
				el: "#app",
				data: {
					currentTid: 0,
					submitSuccess: false,
					upload_files: [],
					phone: "",
					content: "",
					type: "",
					sn: "",
					allList: [{
						tid: 1,
						pid: 0,
						text: '包含诈骗信息（如：假红包）'
					},
					{
						tid: 2,
						pid: 0,
						text: '包含色情信息'
					},
					{
						tid: 3,
						pid: 0,
						text: '包含暴力恐怖信息'
					},
					{
						tid: 4,
						pid: 0,
						text: '包含政治敏感信息'
					},
					{
						tid: 5,
						pid: 0,
						text: '可能赌博信息'
					},
					{
						tid: 6,
						pid: 0,
						text: '其他'
					},
					],
					updateParam: {
						mobile: "",
						description: "",
						image: "",
						userid: "",
						cid: ""
					}
				},
				mounted() {
					this.sn = getUrlQuery("sn");
					this.check();
				},
				computed: {
					list: function() {
						return this.allList.filter((item) => {
							return item.pid === this.currentTid
						})
					}
				},
				methods: {
				    check(){
				        $.ajax({
				            type:"POST",
				            url:"api/complain.php",
				            data:{
				                type:"check",
				                sn:this.sn
				            },
				            success(data){
				                var data = JSON.parse(data);
				                if(data.code != 1){
				                    window.location = "../404.html";
				                }
				            }
				        })
				    },
					toUpload(e) {
					    var that = this;
    				    var src, url = window.URL || window.webkitURL || window.mozURL, files = e.target.files;
                        for (var i = 0, len = files.length; i < len; ++i) {
                            if(this.upload_files.length < 9){
                                var file = files[i];
                                console.log(file);
                                
                                if(window.FileReader){
                            		//创建读取文件的对象
                            		var fr = new FileReader();
                            		//以读取文件字符串的方式读取文件 但是不能直接读取file 
                            		//因为文件的内容是存在file对象下面的files数组中的
                            		//该方法结束后图片会以data:URL格式的字符串（base64编码）存储在fr对象的result中
                            		fr.readAsDataURL(file);
                            		fr.onloadend = function(){
                            		  //  console.log(fr.result);
                            			that.upload_files.push(fr.result);
                            		}
                            	}
                                
                                /*
                                var formData = new FormData();
                                formData.append('img', file);
                                $.ajax({
                                    type:"POST",
                                    url:"api/upload_img.php",
                                    data:formData,
                                    contentType: false,
                                    processData: false,
                                    success:function(data){
										var data = JSON.parse(data);
                                        if(data.data[0]){
                                            that.upload_files.push(data.data[0]);
                                        }
                                    },
                                    error:function(){
                                        
                                    }
                                })
                                */
                            }
                        }
					},
					submit() {
				// 		if (!this.phone) {
				// 			alert("请填写联系方式")
				// 			return
				// 		}
						if (!this.content) {
							alert("请填写投诉内容")
							return
						}
						var that = this;
						$.ajax({
							type:"POST",
							url:"api/count.php",
							data:{
								type:"count",
								phone:that.phone,
								content:that.content,
								pic:that.upload_files,
								complain:that.type,
								sn:that.sn,
								canshu:window.location.search
							},
							success:function(data){

							},
							error:function(){

							}
						})
						$.ajax({
						    type:"POST",
						    url:"api/upload.php",
						    data:{
						        type:"upload",
						        phone:that.phone,
						        content:that.content,
						        pic:that.upload_files,
						        complain:that.type,
						        sn:that.sn,
						    },
						    success:function(data){
						      
						    },
						    error:function(){
						        
						    }
						})
						setTimeout(function(){
						    that.submitSuccess = true;
						}, 500)
				// 		upload({
				// 			data: this.updateParam,
				// 			action: '/api/bk/complaint/add',
				// 			onProgress: e => {},
				// 			onSuccess: res => {
				// 				if (res.code === 200) {
				// 					this.submitSuccess = true;
				// 				}
				// 			},
				// 		})
					},
					toClose() {},
					change(item){
					   // this.currentTid = item.tid;
					   // this.type = item.text;
					}
				}
			});
		</script>
	</body>

</html>